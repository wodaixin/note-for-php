### MySQL 的高可扩展和高可用



#### 分区表的工作原理：

对用户而言，分区表是一个独立的逻辑表，但是底层MySQL将其分成了多个子物理表，这对于用户来说是透明的，每一个分区表都会使用一个独立的文件。

创建表时使用 `partition by` 子句定义每一个分区存放的数据，执行查询时，优化器会根据分区定义过滤那些没有我们需要数据的分区，这样查询只需要所需数据在的分区即可。

分区的主要目的：是将数据按照一个较粗的粒度分在不同的表中，这样可以将相关的数据存放在一起，而且如果想一次性删除整个分区的数据也很方便。

#### 分区的适用场景：

1. 表非常大，无法全部存在内存，或者只在表的最后有热点数据，其他都是历史数据
2. 分区表的数据更容易维护，可以对独立的分区进行独立的操作
3. 分区表的数据可以分布在不同的机器上，从而高效实用资源
4. 可以使用分区表来避免某些特殊的瓶颈
5. 可以备份和恢复独立分区



#### 分区限制：

1. 一个表最多只能有1024个分区
2. 5.1版本中，分区表表达式必须是整数，5.5可以使用列分区
3. 分区字段中如果有主键和唯一索引列，那么主键列和唯一列都必须包含进去
4. 分区表中无法使用外键约束
5. 需要对现有表结构进行修改
6. 所有分区都必须使用相同的存储引擎
7. 分区函数当中可以使用的函数和表达式会有一些限制
8. 某些存储引擎不支持分区
9. 对于 MyISAM 的分区表，不能使用`load index into cache`
10. 对于 MyISAM 表，使用分区时需要打开更多的文件描述符



#### 分库分表的工作原理：

通过一些 HASH 算法或者工具实现将易子昂数据表垂直或者水平进行物理切分



#### 适用场景：

1. 单表记录条数达到百万到千万级别时
2. 解决表锁的问题

#### 分表方式：

1. 水平分割：表很大，分割后可以降低在查询是需要读的数据和索引的页数，同时也降低了索引的层数，提高查询速度

   

   使用场景：

   * 表中的数据本身就有独立性，例如表中分别记录各个地区的数据或者不同时期的数据，特别是有些数据常用，有些不常用
   * 需要把数据存放在多个介质上

   

   水平分表缺点：

   * 给应用增加复杂度，通常查询时需要多个表名，查询所有数据都需 `UNION` 操作
   * 在许多数据库应用中，这种复杂性会超过它带来的有点，查询时会增加读一个索引层的磁盘次数

2. 垂直分表：把主键和一些列放在一个表，然后把主键和另外的列放在另一个表中

   

   使用场景：

   * 如果一个表中某些列常用，而另外一些列不常用
   * 可以使数据行变小，一个数据页能够存储更多的数据，查询时减少 I/O 次数

   

   垂直分表缺点：管理冗余列，查询所有数据需要 `join` 操作



#### 分表缺点：

有一些分表的策略基于应用层的逻辑算法，一旦逻辑算法改变，整个分区表逻辑都会改变，扩展性较差

对于应用层来说，逻辑算法无疑增加开发成本



#### MySQL 的复制原理及负载均衡

MySQL 主从复制工作原理：

1. 在主库上把数据更改记录到二进日志

2. 从库将主库的日志复制到自己的中继日志

3. 从库读取中继日志中的事件，将其重放到从库数据库中



MySQL 主从复制解决的问题：

数据分布：随意停止或者开始复制，并在不同地理位置分布数据备份

负载均衡：降低单个服务器的压力

高可用和故障切换：帮助应用程序避免单点失败

升级测试：可以使用更高版本的 MySQL 作为从库



